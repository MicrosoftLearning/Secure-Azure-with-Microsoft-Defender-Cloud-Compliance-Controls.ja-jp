---
lab:
  title: 演習 02 - 仮想ネットワーク インフラストラクチャを作成する
  module: Module 03 - Filter network traffic with a network security group using the Azure portal
---


>**注**: このラボを完了するには、管理者アクセス権のある [Azure サブスクリプション](https://azure.microsoft.com/en-us/free/?azure-portal=true) が必要です。 


Azure 仮想ネットワーク内の Azure リソースが送受信するネットワーク トラフィックは、ネットワーク セキュリティ グループを使ってフィルター処理できます。 ネットワーク セキュリティ グループには、IP アドレス、ポート、およびプロトコルでネットワーク トラフィックをフィルター処理するセキュリティ規則が含まれています。 ネットワーク セキュリティ グループがサブネットに関連付けられている場合、そのサブネットにデプロイされたリソースにセキュリティ規則が適用されます。

## アーキテクチャの図

![image](https://github.com/MicrosoftLearning/Secure-Azure-services-and-workloads-with-Microsoft-Cloud-Security-Benchmark/assets/91347931/1bfec315-129b-48a9-9c35-1f21c837068f)

---

## スキルアップ タスク

- ネットワーク セキュリティ グループとセキュリティ規則を作成する
- アプリケーション セキュリティ グループを作成する
- 仮想ネットワークを作成し、ネットワーク セキュリティ グループをサブネットに関連付ける
- 仮想マシンをデプロイし、そのネットワーク インターフェイスをアプリケーション セキュリティ グループに関連付ける

### ラボの推定所要時間: 20 分

## 演習の手順 

### Azure リソース グループと仮想ネットワークを作成します。

>**注**: 次のタスクではリソース サブネットを持つ仮想ネットワークを作成します。

1. ブラウザー セッションを開始し、[Azure portal メニュー](https://portal.azure.com/)にサインインします。             
   
2. ポータルの上部にある検索ボックスに、「**仮想ネットワーク**」と入力します。 検索結果で、**[仮想ネットワーク]** を選択します。

3. **[仮想ネットワーク]** ページで、**[+ 作成]** を選択します。

4. **[仮想ネットワークの作成]** の **[基本]** タブで、次の情報を入力するか選択します。
   
   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|「**azure-rg-1**」と入力します。|
   |**インスタンスの詳細**|
   |仮想ネットワーク名|「**vnet-1**」と入力します。|
   |リージョン|**[(米国) 米国東部]** を選択します。|  
    
5. **[次へ]** を選択して、**[セキュリティ]** タブに進みます。
  
6. 
          **[次へ]** を選択して、**[IP アドレス]** タブに進みます。

7. **[サブネット]** のアドレス空間ボックスで、**既定**のサブネットを選択します。

8. **[サブネットの編集]** テンプレートで、次の情報を入力するか選びます。

   |設定|値|
   |---|---|
   |**サブネットの詳細**|
   |サブネットの目的|既定の設定の [既定] のままにします。|
   |Name|「**subnet-1**」と入力します。|
   |開始アドレス|既定の設定 10.0.0.0/16 のままにします。|
   |サイズ|既定の設定 [/24 (256 アドレス)] のままにします。|

    ![image](https://github.com/user-attachments/assets/82076f64-6a7f-4235-942d-d83e32ed6ea1)

10. **[保存]** を選択します。

11. 画面の下部にある **[確認と作成]** を選択し、検証に合格したら **[作成]** を選択します。

     ![image](https://github.com/user-attachments/assets/c53a04e4-d760-4e28-b998-1d48a56702f1)

### アプリケーション セキュリティ グループを作成すると、Web サーバーなど、同様の機能を持つサーバーをグループ化できます。

アプリケーション セキュリティ グループ (ASG) を使用すると、Web サーバーなど、同様の機能を持つサーバーをグループ化できます。

1. ポータルの上部にある検索ボックスに、「**アプリケーション セキュリティ グループ**」と入力します。 検索結果から **[アプリケーションのセキュリティ グループ]** を選びます。

2. **[アプリケーション セキュリティ グループ]** ページで、**[+ 作成]** を選択します。

3. **[アプリケーション セキュリティ グループの作成]** の **[基本]** ページで、次の情報を入力または選択します。
   
   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**[az-rg-1]** を選択します。|
   |**インスタンスの詳細**|
   |名前|「**asg-web**」と入力します。|
   |リージョン|**[米国東部]** を選択します。|  
    
4. **[Review + create](レビュー + 作成)** を選択します。

5. **［作成］** を選択します

6. 上記の手順を繰り返し、次の値を指定します。
    
   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**[az-rg-1]** を選択します。|
   |**インスタンスの詳細**|
   |名前|「**asg-mgmt**」と入力します。|
   |リージョン|**[米国東部]** を選択します。|

7. **[Review + create](レビュー + 作成)** を選択します。

8. **［作成］** を選択します

### ネットワーク セキュリティ グループを作成し、仮想ネットワーク内のネットワーク トラフィックをセキュリティで保護します。

ネットワーク セキュリティ グループ (NSG) は、仮想ネットワーク内のネットワーク トラフィックをセキュリティで保護するものです。

1. ポータルの上部にある検索ボックスに、「**ネットワーク セキュリティ グループ**」と入力します。 検索結果から **[ネットワーク セキュリティ グループ]** を選択します。

>**注**: 「ネットワーク セキュリティ グループ」の検索結果に「ネットワーク セキュリティ グループ (クラシック)」が表示される場合があります。 ネットワーク セキュリティ グループを選択します。

2. [**ネットワーク セキュリティ グループ**] ページで、 **[+ 作成]** を選択します。

3. **[ネットワーク セキュリティ グループの作成]** の **[基本]** タブで、この情報を入力または選択します。
   
   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**[az-rg-1]** を選択します。|
   |**インスタンスの詳細**|
   |名前|「**nsg-1**」と入力します。|
   |リージョン|**[米国東部]** を選択します。|  
    
4. **[Review + create](レビュー + 作成)** を選択します。

5. **［作成］** を選択します

### ネットワーク セキュリティ グループをサブネットに関連付ける

>**注**: このタスクでは、先ほど作成した仮想ネットワークのサブネットにネットワーク セキュリティ グループを関連付けます。

1. ポータルの上部にある検索ボックスに、「**ネットワーク セキュリティ グループ**」と入力します。 検索結果から **[ネットワーク セキュリティ グループ]** を選択します。
   
2. **[nsg-1]** を選択します。

3. **[nsg-1]** の **[設定]** セクションから **[サブネット]** を選択します。

4. **[nsg-1 | サブネット]** ページで **[+ 関連付け]** を選択します。

   ![image](https://github.com/user-attachments/assets/bfc18dd3-3345-4c05-9981-4f479d5f7c7e)

6. 「**サブネットの関連付け**」で **仮想ネットワーク**として **[vnet-1 (az-rg-1)]** を選択します。

7. **[サブネット]** として **[subnet-1]** を選択した後に、**[OK]** を選択します。

### 前に作成した仮想ネットワークのサブネットにネットワーク セキュリティ グループのセキュリティ規則を関連付けます。

1. **[nsg-1]** の **[設定]** セクションから **[受信セキュリティ規則]** を選択します。
   
2. **[nsg-1 | 受信セキュリティ規則]** ページで **[+ 追加]** を選択します。

3. **asg-web** アプリケーション セキュリティ グループに、ポート 80 と 443 を許可するセキュリティ規則を作成します。 **[受信セキュリティ規則の追加]** ページで、次の情報を入力または選択します。

   |設定|値|
   |---|---|
   |source|既定値の **[Any](すべて)** のままにします。|
   |Source port ranges|ポート範囲は既定の設定のままにします。|
   |宛先|**[アプリケーションのセキュリティ グループ]** を選択します。|
   |宛先アプリケーションのセキュリティ グループ|**[asg-web]** を選択します。|
   |Service|既定の設定の [カスタム] のままにします。|
   |宛先ポート範囲|「**80,443**」と入力します。|
   |Protocol|**[TCP]** を選択します。|
   |アクション|既定の設定の [許可] のままにします。|
   |優先順位|既定の設定 100 のままにします。|
   |Name|「**allowweball**」と入力します。|

4. **[追加]** を選択します。

5. 次の情報を使用して、前の手順を完了します。

   |設定|値|
   |---|---|
   |source|既定値の **[Any](すべて)** のままにします。|
   |Source port ranges|ポート範囲は既定の設定のままにします。|
   |宛先|**[アプリケーションのセキュリティ グループ]** を選択します。|
   |宛先アプリケーションのセキュリティ グループ|**[asg-mgmt]** を選択します。|
   |サービス|**[RDP]** を選択します。|
   |宛先ポート範囲|既定の設定 3389 のままにします。|
   |プロトコル|既定の設定の [TCP] のままにします。|
   |アクション|既定の設定の [許可] のままにします。|
   |優先順位|既定の設定 110 のままにします。|
   |Name|「**allowrdpall**」と入力します。|
   
6. **[追加]** を選択します。

### 前に作成した仮想ネットワーク内に 2 つの仮想マシン (VM) を作成します。

1. ポータルの上部にある検索ボックスに「仮想マシン」と入力します。**** 検索結果から **[仮想マシン]** を選択します。

2. **[仮想マシン]** で **[+ 作成]**、**[Azure 仮想マシン]** の順に選択します。
   
3. **[仮想マシンの作成]** の **[基本]** ページで、この情報を入力または選択します。

   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**[az-rg-1]** を選択します。|
   |**インスタンスの詳細**|
   |仮想マシン名|「**vm-1**」と入力します。|
   |リージョン|**[(米国) 米国東部]** を選択します。|
   |可用性のオプション|[可用性ゾーン] ドロップダウン メニューから **[インフラストラクチャ冗長は不要]** を選択します|
   |セキュリティの種類|[セキュリティの種類] ドロップダウン メニューから **[標準]** を選択します。|
   |Image|[イメージ] ドロップダウン メニューから **[Windows Server 2022 Datacenter:Azure Edition - x64 Gen2]** を選択します。|
   |VM アーキテクチャ|既定の設定 x64 のままにします。|
   |Azure Spot 割引で実行する|既定の設定のオフのままにします。|
   |サイズ|既定の設定の [Standard_D2s_v3-2 vcpus、8 GiB メモリ] のままにします。|
   |**管理者アカウント**|
   |ユーザー名|「**Tenantadmin1**」と入力します。|
   |Password|「**Superuser#150**」と入力します。|
   |[パスワードの確認入力]|「**Superuser#150**」ともう一度入力します。|
   |**受信ポートの規則**|
   |パブリック受信ポート|**[なし]** を選択します。|
 
4. **[次へ: ディスク]**、**[次へ: ネットワーク]** の順に選択します。

5. **[ネットワーク]** ページで、次の情報を確認または入力します。

   |設定|値|
   |---|---|
   |**ネットワーク インターフェイス**|
   |仮想ネットワーク|**vnet-1** を選択します。|
   |Subnet|既定の設定 subnet-1 (10.0.0.0/24) のままにします。|
   |パブリック IP|既定の設定の [(新規) vm-1-ip] のままにします。|
   |NIC ネットワーク セキュリティ グループ|**[なし]** を選択します。|
   
6. ページの下部にある **[確認および作成]** ボタンを選択して次に進みます。

7. **［作成］** を選択します VM のデプロイには数分かかることがあります。
  
   - 2 つ目の仮想マシンを作成します。

   - 前の手順を繰り返して、**vm-2** という名前の 2 つ目の仮想マシンを作成します。

   - VM がデプロイを完了するまで待ってから、次のセクションに進みます。

### ネットワーク インターフェイスをアプリケーション セキュリティ グループに関連付ける

>**注**: VM を作成したとき、Azure では各 VM 用のネットワーク インターフェイスが作成され、各 VM に接続されています。 各 VM 用のネットワーク インターフェイスを、前に作成したアプリケーション セキュリティ グループの 1 つに追加します。

1. ポータルの上部にある検索ボックスに「仮想マシン」と入力します。**** 検索結果から **[仮想マシン]** を選択します。

2. **vm-1** を選択します。
 
3. **vm-1** のセクションから **[ネットワーク]** を選択します。

4. **vm-1 の **[ネットワーク]** セクション から **[アプリケーション セキュリティ グループ]** を選択します。 **[+ アプリケーション セキュリティ グループの追加]** を選択します。

5. **[アプリケーション セキュリティ グループの追加]** テンプレートで、**[アプリケーション セキュリティ グループ]** テンプレートから **[asg-mgmt]** を選択し、テンプレート ページの下部にある **[追加]** ボタンをクリックします。

   ![image](https://github.com/user-attachments/assets/9bb38a91-8aa6-427b-9b6d-b01c5333ad4c)

7. **[vm-2]** に対して前の手順を繰り返し、**[アプリケーション セキュリティ グループ]** テンプレートで **[asg-web]** を選択します。

> **結果**: Azure portal を使用して、仮想ネットワーク インフラストラクチャを作成し、ネットワーク セキュリティ グループを使用してネットワーク トラフィックをフィルター処理しました。

> **注**: 以下の演習で必要になるため、このラボからリソースを削除しないでください。演習 05: VM で Just-In-Time アクセスを有効にする、演習 06a: Key Vault ファイアウォールと仮想ネットワークを構成する。
