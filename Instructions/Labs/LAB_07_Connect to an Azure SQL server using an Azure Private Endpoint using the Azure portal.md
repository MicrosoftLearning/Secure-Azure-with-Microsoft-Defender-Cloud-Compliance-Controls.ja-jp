---
lab:
  title: 演習 07 - Azure portal を使用して Azure プライベート エンドポイント経由で Azure SQL サーバーに接続する
  module: Module 08 - Connect to an Azure SQL server using an Azure Private Endpoint using the Azure portal
---


>**注**: このラボを完了するには、管理者アクセス権のある [Azure サブスクリプション](https://azure.microsoft.com/en-us/free/?azure-portal=true) が必要です。 


Azure プライベート エンドポイントは、Azure における Private Link の基本的な構成要素です。 これにより、仮想マシン (VM) などの Azure リソースは、Azure SQL サーバーなどの Private Link リソースと非公開かつ安全に通信できます。

---

## スキルアップ タスク

- 仮想ネットワークと bastion ホストを作成します。
  
- 仮想マシンを作成します。
  
- Azure SQL サーバーとプライベート エンドポイントを作成します。
  
- SQL サーバー プライベート エンドポイントへの接続をテストします。

## 演習の手順 

### リソース グループと仮想ネットワークを作成します。

>**注**:bastion ホストは、プライベート エンドポイントをテストする目的で、仮想マシンに安全に接続するために使用されます。 

1. ブラウザー セッションを開始し、[Azure portal メニュー](https://portal.azure.com/)にサインインします。
   
2. ポータルの上部にある検索ボックスに、「**仮想ネットワーク**」と入力します。 検索結果で、**[仮想ネットワーク]** を選択します。

3. **[仮想ネットワーク]** ページで、**[+ 作成]** を選択します。

4. **[仮想ネットワークの作成]** の **[基本]** タブで、次の情報を入力または選択します。
   
   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**az-rg-1** を選択します。|
   |**インスタンスの詳細**|
   |仮想ネットワーク名|「**vnet-2**」と入力します。|
   |リージョン|**[(米国) 米国東部]** を選択します。|  
    
5. **[次へ]** を選択して、**[セキュリティ]** タブに進みます。
  
6. [セキュリティ] タブの Azure Bastion のセクションで **[Azure Bastion を有効にする]** を選びます。

   >**注意**: Azure Bastion は、TLS 経由で仮想マシンへのセキュリティで保護された RDP/SSH 接続を提供する有料サービスです。 Azure Bastion 経由で接続する場合、ご自分の仮想マシンにパブリック IP アドレスは必要ありません。 

7. **Azure Bastion** フィールドに次の情報を入力するか、選択します。

   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |Azure Bastion ホスト |**az-bastionhost-1a** と入力します。|
   |Azure Bastion のパブリック IP アドレス名|**[パブリック IP アドレスを作成]** を選びます|
   |パブリック IP アドレスを追加する|**[OK]** を選択します。|

9. **[次へ]** を選択して、**[IP アドレス]** タブに進みます。

10. **[サブネット]** 列の下にある既存の構成済みの **[IPv4 アドレス空間]** ボックスで、**[既定]** のエントリをクリックします。

11. **[サブネットの編集]** テンプレートで、次の情報を入力するか選びます。

    |設定|値|
    |---|---|
    |**プロジェクトの詳細**|
    |サブネットの目的|既定の設定の [既定] のままにします。|
    |Name|**subnet-2**|
    |IPv4 アドレス範囲|既定の設定 10.0.0.0/16 のままにします。|
    |開始アドレス|既定の設定 [/24 (256 アドレス)] のままにします。|

13. **[サブネットの編集]** ページの下部にある **[保存]** を選択します。

14. **[IP アドレス]** ページの下部にある **[確認および作成]** を選択します。

    >**注**:Bastion のデプロイは、完全なインスタンス化まで最大 15 分かかる場合があります。

15. **[確認および作成]** ページの下部にある **[作成]** を選択します。
 
### 仮想マシンを作成します。

>**注**: このタスクでは、プライベート エンドポイントのテストに使用する仮想マシンを作成します。

1. ポータルで、**[仮想マシン]** を検索して選択します。

2. **[仮想マシン]** で **[+ 作成]**、**[Azure 仮想マシン]** の順に選択します。

3. [仮想マシンの作成] の **[基本]** ページで、この情報を入力または選択します。

   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**[az-rg-1]** を選択します。|
   |**インスタンスの詳細**|
   |仮想マシン名|「**vm-3**」と入力します。|
   |リージョン|**[(米国) 米国東部]** を選択します。|
   |可用性のオプション|[可用性ゾーン] ドロップダウン メニューから **[インフラストラクチャ冗長は不要]** を選択します|
   |セキュリティの種類|[セキュリティの種類] ドロップダウン メニューから **[標準]** を選択します。|
   |Image|**[Windows Server 2022 Datacenter - x64 Gen2]** を選択します。|
   |VMアーキテクチャ|**[x64]** を選択します。|
   |Azure Spot 割引で実行する|既定の設定のオフのままにします。|
   |サイズ|既定の設定の [Standard_D2s_v3-2 vcpus、8 GiB メモリ] のままにします。|
   |**管理者アカウント**|
   |ユーザー名|「**Tenantadmin2**」と入力します。|
   |Password|「**Superuser#170**」と入力します。|
   |[パスワードの確認入力]|「**Superuser#170**」ともう一度入力します。|
   |**受信ポートの規則**|
   |受信ポートの選択|**[なし]** を選択します。|

5. **[次へ: ディスク]**、**[ネットワーク]** の順に選びます。
  
6. **[ネットワーク]** ページで、この情報を入力または選択します。

   |設定|値|
   |---|---|
   |**ネットワーク インターフェイス**|
   |仮想ネットワーク|**[vnet-2]** を選択します。|
   |Subnet|**[subnet-2 (10.0.0.0/24)]** を選択します。|
   |パブリック IP|**[なし]** を選択します。|
   |NIC ネットワーク セキュリティ グループ|**[Basic]** を選択します。|
   |パブリック受信ポート|**[なし]** を選択します。|
   |受信ポートの選択|既定の設定の空白のままにします。|
   |VM が削除された場合に NIC を削除する|既定の設定である [高速ネットワークを有効にする] がオンのままにします。|
   |負荷分散|既定の設定の [なし] のままにします。|
  
6. **[Review + create](レビュー + 作成)** を選択します。

7. 設定を確認し、 **[作成]** を選択します。

### Azure SQL サーバーとプライベート エンドポイントを作成する

>**注**: このタスクでは、Azure に SQL サーバーを作成します。

1. ポータルの上部にある検索ボックスに、「**SQL データベース**」と入力します。 検索結果で **[SQL データベース]** を選択します。

2. **[SQL データベース]** ページで、**[+ 作成]** を選択します。
   
3. **[SQL データベースの作成]** の **[基本]** タブで、次の情報を入力または選択します。

   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**az-rg-1** を選択します。|
   |**データベースの詳細**|
   |データベース名|「**az-sql-db1a**」と入力します。|
   |サーバー名|「**az-sql-svr1a**」と入力します。 この名前を取得する場合は、一意の名前を作成します。|
   |場所|**[(米国) 米国東部]** を選択します。|
   |**認証**|
   |認証方法|**[SQL 認証を使用する]** を選択します。|
   |サーバー管理者のログイン|「**Tenantadmin2**」と入力します。|
   |Password|「**Superuser#170**」と入力します。|
   |パスワードの確認|「**Superuser#170**」と入力します。|

4. **[OK]** を選択します。
   
   |設定|値|
   |---|---|
   |**データベースの詳細**|
   |SQL エラスティック プールを使用しますか?|既定の設定の [いいえ] のままにします。|
   |ワークロード環境|既定の設定の [開発] のままにします。|
   |コンピューティングとストレージ|既定の設定の [汎用 - サーバーレス] のままにします。|
   |**バックアップ ストレージの冗長性**|
   |バックアップ ストレージの冗長性|**[ローカル冗長バックアップ ストレージ]** を選択します。|
   
5. **[ネットワーク]** タブまたは **[次へ: ネットワーク]** ボタンをクリックします。

6. **[ネットワーク]** タブで、次の情報を入力または選択します。

   |設定|Value|
   |---|---|
   |**ネットワーク接続**|
   |接続方法|**[プライベート エンドポイント]** を選択します。|
   |接続ポリシー|既定の設定である [既定 - Azure 内からのすべてのクライアント接続にリダイレクト ポリシーを使用し (プライベート エンドポイント接続を除く)、Azure 外からのすべてのクライアント接続にプロキシを使用する] のままにします|
   |暗号化接続|既定の設定の [TLS.12] のままにします。|

7. **[プライベート エンドポイント]** で **[+ プライベート エンドポイントの追加]** を選択します。

8. **[プライベート エンドポイントの作成]** で、次の情報を入力または選択します。

   |設定|値|
   |---|---|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**az-rg-1** を選択します。|
   |場所|**[米国東部]** を選択します。|
   |Name|「**az-pe-1a**」と入力します。|
   |ターゲット サブリソース|既定の設定の [SqlServer] のままにします。|
   |**ネットワーク**|
   |仮想ネットワーク|**[vnet-2]** を選択します。|
   |Subnet|**[subnet-2]** を選択します。|
   |**プライベート DNS の統合**|
   |プライベート DNS ゾーンとの統合|既定の設定の [はい] のままにします。|
   |プライベート DNS ゾーン|既定の設定の [(新規) privatelink.database.windows.net] のままにします。|

9. **[OK]** を選択します。

10. **[Review + create](レビュー + 作成)** を選択します。

11. **［作成］** を選択します

### Azure SQL 論理サーバーへのパブリック アクセスを無効にする

>**注**: このタスクでは、Azure SQL サーバーへのすべてのパブリック アクセスを無効にして、自分の仮想ネットワークからの接続のみを許可するとします。 **[パブリック アクセス]** 設定は、既定で **[無効にする]** になっている場合があります。

1. Azure portal の検索ボックスに、「**az-sql-svr1a**」または前の手順で入力したサーバー名を入力します。

2. **az-sql-svr1a** の **[セキュリティ]** セクションから **[ネットワーク]** を選択します。 **[ネットワーク]** ページで、**[パブリック アクセス]** タブを選択し、**[パブリック ネットワーク アクセス]** に対して **[無効]** を選択します。

   ![image](https://github.com/MicrosoftLearning/Secure-Azure-services-and-workloads-with-Microsoft-Cloud-Security-Benchmark/assets/91347931/44ff5c24-70cf-49ed-b2ab-5e210c478b3a)

3. **[保存]** を選択します。

### プライベート エンドポイントへの接続のテスト

>**注**: このタスクでは、前の手順で作成した仮想マシンを使用して、プライベート エンドポイントを通じて SQL サーバーに接続します。

1. 左側のナビゲーション ペインで **[リソース グループ]** を選択します。

2. **az-rg-1** を選択します。

3. **vm-3** を選択します。

4. **vm-3** の概要ページで、[接続]、**[Bastion]** の順に選択します。

5. 仮想マシンの作成時に入力したユーザー名「**Tenantadmin2**」とパスワード「**Superuser#170**」を入力します。

   **重要:** [接続] を選択する前に、[Edge の設定]、[ポップアップとリダイレクト] に移動し、[ブロック] スイッチを **[オフ]** に切り替えます。

7. **[接続]** ボタンを選択します。
  
8. 接続後にサーバーで Windows PowerShell を開きます。

9. 「`nslookup sqlserver-name.database.windows.net.`」を入力して、**sqlserver-name** を前の手順で作成した SQL サーバーの名前に置き換えます。 以下に表示されるようなメッセージが返されます。

   ````  
   Server:  UnKnown
   Address:  168.63.129.16
   
   Non-authoritative answer:
   Name:    az-sql-svr1a.privatelink.database.windows.net
   Address:  10.1.0.5
   Aliases:  az-sql-svr1a.database.windows.net
   ````
    
>**注**: SQL サーバー名には 10.1.0.5 というプライベート IP アドレスが返されます。 このアドレスは、前に作成した **vnet-2** 仮想ネットワークの **az-sql-svr1a** サブネットにあります。

9. [SQL Server Management Studio](https://learn.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?preserve-view=true&view=sql-server-2017) を **vm-3** にインストールします。
 
10. **SQL Server Management Studio** を開きます。

11. **[サーバーに接続]** で、次の情報を入力または選択します。

    |設定|値|
    |---|---|
    |サーバーの種類|**データベース エンジン**を選択します。|
    |サーバー名|**az-sql-svr1a.database.windows.net** と入力します。|
    |認証|**[SQL Server 認証]** を選択します。|
    |ユーザー名|「**Tenantadmin2**」と入力します。|
    |Password|「**Superuser#170**」と入力します。|
    |パスワードを保存する|**[はい]** を選択します。|
    |接続セキュリティ|
    |暗号化|既定の設定は [必須] のままにします。|
   
13. **[接続]** を選択します。

14. 左側のメニューでデータベースを参照します。

15. vm-3 へのリモート デスクトップ接続を閉じます。
  
> **結果**: Azure portal から Azure プライベート エンドポイントを使用して Azure SQL サーバーに接続しました。
