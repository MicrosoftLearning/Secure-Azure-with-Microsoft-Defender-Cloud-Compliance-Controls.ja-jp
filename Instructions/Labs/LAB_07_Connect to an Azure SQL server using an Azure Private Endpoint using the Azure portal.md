---
lab:
  title: 演習 07 - Azure portal を使用して Azure プライベート エンドポイント経由で Azure SQL サーバーに接続する
  module: Module 08 - Connect to an Azure SQL server using an Azure Private Endpoint using the Azure portal
---


>**注**: このラボを完了するには、管理者アクセス権のある [Azure サブスクリプション](https://azure.microsoft.com/en-us/free/?azure-portal=true) が必要です。 


Azure プライベート エンドポイントは、Azure における Private Link の基本的な構成要素です。 これにより、仮想マシン (VM) などの Azure リソースは、Azure SQL サーバーなどの Private Link リソースと非公開かつ安全に通信できます。

---

## スキルアップ タスク

- 仮想ネットワークと bastion ホストを作成します。
  
- 仮想マシンを作成します。
  
- Azure SQL サーバーとプライベート エンドポイントを作成します。
  
- SQL サーバー プライベート エンドポイントへの接続をテストします。

## 演習の手順 

### リソース グループと仮想ネットワークを作成します。

>**注**:bastion ホストは、プライベート エンドポイントをテストする目的で、仮想マシンに安全に接続するために使用されます。 

1. ブラウザー セッションを開始し、[Azure portal メニュー](https://portal.azure.com/)にサインインします。
   
2. ポータルの上部にある検索ボックスに、「**仮想ネットワーク**」と入力します。 検索結果で、**[仮想ネットワーク]** を選択します。

3. **[仮想ネットワーク]** ページで、**[+ 作成]** を選択します。

4. **[仮想ネットワークの作成]** の **[基本]** タブで、次の情報を入力または選択します。
   
   |設定|値|
   |---|---|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**[az-rg-1]** を選択します。|
   |**インスタンスの詳細**|
   |仮想ネットワーク名|「**vnet-2**」と入力します。|
   |リージョン|**[(米国) 米国東部]** を選択します。|  
    
5. **[次へ]** を選択して、**[セキュリティ]** タブに進みます。
  
6. [セキュリティ] タブの Azure Bastion のセクションで **[Azure Bastion を有効にする]** を選びます。

>**注意**: Azure Bastion は、TLS 経由で仮想マシンへのセキュリティで保護された RDP/SSH 接続を提供する有料サービスです。 Azure Bastion 経由で接続する場合、ご自分の仮想マシンにパブリック IP アドレスは必要ありません。 

7. **Azure Bastion** フィールドに次の情報を入力するか、選択します。

   |設定|Value|
   |---|---|
   |Azure Bastion ホスト |**az-bastionhost-1a** と入力します。|
   |Azure Bastion のパブリック IP アドレス名|**[パブリック IP アドレスを作成]** を選びます|
   |パブリック IP アドレスを追加する|**[OK]** を選択します。|

8. **[次へ]** を選択して、**[IP アドレス]** タブに進みます。

9. **[サブネット]** 列の下にある既存の構成済みの **[IPv4 アドレス空間]** ボックスで、**[既定]** のエントリをクリックします。

10. **[サブネットの編集]** テンプレートで、次の情報を入力するか選びます。

    |設定|Value|
    |---|---|
    |サブネットの目的|既定の設定の [既定] のままにします。|
    |Name|**subnet-2**|
    |IPv4 アドレス空間を含めます|既定の設定のチェックマークが付いたままにします。|
    |IPv4 アドレス範囲|既定の設定 10.0.0.0/16 のままにします。|
    |開始アドレス|10.0.0.0.|
    |サイズ|既定の設定 [/24 (256 アドレス)] のままにします。|
    |サブネットのアドレス範囲|10.0.0.0-10.0.0.255。|

11. **[サブネットの編集]** ページの下部にある **[保存]** を選択します。

12. **[IP アドレス]** ページの下部にある **[確認および作成]** を選択します。

13. **[確認および作成]** ページの下部にある **[作成]** を選択します。

>**注**:Bastion のデプロイは、完全なインスタンス化まで最大 15 分かかる場合があります。
 
### 仮想マシンを作成します。

>**注**: このタスクでは、プライベート エンドポイントのテストに使用する仮想マシンを作成します。

1. ポータルで、**[仮想マシン]** を検索して選択します。

2. **[仮想マシン]** で **[+ 作成]**、**[Azure 仮想マシン]** の順に選択します。

3. [仮想マシンの作成] の **[基本]** ページで、この情報を入力または選択します。

   |設定|Value|
   |---|---|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**[az-rg-1]** を選択します。|
   |**インスタンスの詳細**|
   |仮想マシン名|「**vm-3**」と入力します。|
   |リージョン|**[(米国) 米国東部]** を選択します。|
   |可用性のオプション|[可用性ゾーン] ドロップダウン メニューから **[インフラストラクチャ冗長は不要]** を選択します|
   |セキュリティの種類|[セキュリティの種類] ドロップダウン メニューから **[標準]** を選択します。|
   |Image|**[Windows Server 2022 Datacenter - x64 Gen2]** を選択します。|
   |VMアーキテクチャ|**[x64]** を選択します。|
   |Azure Spot 割引で実行する|既定の設定のオフのままにします。|
   |サイズ|既定の設定の [Standard_D2s_v3-2 vcpus、8 GiB メモリ] のままにします。|
   |**管理者アカウント**|
   |ユーザー名|「**Tenantadmin2**」と入力します。|
   |Password|「**Superuser#170**」と入力します。|
   |[パスワードの確認入力]|「**Superuser#170**」ともう一度入力します。|
   |**受信ポートの規則**|
   |パブリック受信ポート|**[なし]** を選択します。|
   |受信ポートの選択|既定の設定はグレー表示されます。|

4. **[次へ: ディスク]**、**[ネットワーク]** の順に選びます。
  
5. **[ネットワーク]** ページで、この情報を入力または選択します。

   |設定|値|
   |---|---|
   |**ネットワーク インターフェイス**|
   |仮想ネットワーク|**[vnet-2]** を選択します。|
   |Subnet|**[subnet-2 (10.0.0.0/24)]** を選択します。|
   |パブリック IP|**[なし]** を選択します。|
   |NIC ネットワーク セキュリティ グループ|**[Basic]** を選択します。|
   |パブリック受信ポート|**[なし]** を選択します。|
   |受信ポートの選択|既定の設定はグレー表示されます。|
   |VM が削除された場合に NIC を削除する|既定の設定である [高速ネットワークを有効にする] がオンのままにします。|
   |負荷分散|既定の設定の [なし] のままにします。|
  
6. **[Review + create](レビュー + 作成)** を選択します。

7. 設定を確認し、 **[作成]** を選択します。

### Azure SQL サーバーとプライベート エンドポイントを作成する

>**注**: このタスクでは、Azure に SQL サーバーを作成します。

1. ポータルの上部にある検索ボックスに、「**SQL データベース**」と入力します。 検索結果で **[SQL データベース]** を選択します。

2. **[SQL データベース]** ページで、**[+ 作成]** を選択します。
   
3. **[SQL データベースの作成]** の **[基本]** タブで、次の情報を入力または選択します。

   |設定|値|
   |---|---|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**az-rg-1** を選択します。|
   |**データベースの詳細**|
   |データベース名|「**az-sql-db1a**」と入力します。|
   |[サーバー]|**[新規作成]** を選択します。|
   |**サーバーの詳細**|
   |サーバー名|「**az-sql-srv1a**」と入力します。|
   |場所|既定の設定の [(米国) 米国東部] のままにします。|
   |**認証**|
   |認証方法|**[SQL 認証を使用する]** を選択します。|  
   |サーバー管理者のログイン|「**Tenantadmin2**」と入力します。|
   |Password|「**Superuser#170**」と入力します。|
   |パスワードの確認|「**Superuser#170**」と入力します。|

4. **[OK]** を選択します。
    
   |設定|値|
   |---|---|
   |**データベースの詳細**|
   |SQL エラスティック プールを使用しますか?|既定の設定の [いいえ] のままにします。|
   |ワークロード環境|既定の設定の [開発] のままにします。|
   |コンピューティングとストレージ|既定の設定の [汎用 - サーバーレス] のままにします。|
   |**バックアップ ストレージの冗長性**|
   |バックアップ ストレージの冗長性|**[ローカル冗長バックアップ ストレージ]** を選択します。|
   
5. **[ネットワーク]** タブまたは **[次へ: ネットワーク]** ボタンをクリックします。

6. **[ネットワーク]** タブで、次の情報を入力または選択します。

   |設定|Value|
   |---|---|
   |**ネットワーク接続**|
   |接続方法|**[プライベート エンドポイント]** を選択します。|
   |接続ポリシー|既定の設定である [既定 - Azure 内からのすべてのクライアント接続にリダイレクト ポリシーを使用し (プライベート エンドポイント接続を除く)、Azure 外からのすべてのクライアント接続にプロキシを使用する] のままにします|
   |暗号化接続|既定の設定の [TLS.12] のままにします。|

7. **[プライベート エンドポイント]** セクションで、**[+ プライベート エンドポイントの追加]** を選択します。

8. **[Review + create](レビュー + 作成)** を選択します。

9. **［作成］** を選択します

10. **[プライベート エンドポイントの作成]** で、次の情報を入力または選択します。

   |設定|値|
   |---|---|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|**az-rg-1** を選択します。|
   |場所|**[米国東部]** を選択します。|
   |Name|「**az-pe1a**」と入力します。|
   |ターゲット サブリソース|既定の設定の [SqlServer] のままにします。|
   |**ネットワーク**|
   |仮想ネットワーク|**[vnet-2]** を選択します。|
   |Subnet|**[subnet-2]** を選択します。|
   |**プライベート DNS の統合**|
   |プライベート DNS ゾーンとの統合|既定の設定の [はい] のままにします。|
   |プライベート DNS ゾーン|既定の設定の [(新規) privatelink.database.windows.net] のままにします。|

11. **[OK]** を選択します。

12. **[Review + create](レビュー + 作成)** を選択します。

13. **［作成］** を選択します

>**注**: Azure SQL サーバーとプライベート エンドポイントのデプロイは、完全なインスタンス化に最大 10 分かかる場合があります。

### 特定のパブリック インターネット IP アドレスで Azure SQL 論理サーバーにアクセスできるようにする

>**注**: このタスクでは、Azure SQL サーバーへのパブリック アクセスを有効にして、自分の仮想ネットワークからの接続のみを許可するとしています。 [パブリック アクセス] 設定は、既定で **[無効にする]** になっている場合があります。

1. Azure portal の検索ボックスに、「**az-sql-srv1a**」または前の手順で入力したサーバー名を入力します。
   
2. **[az-sql-srv1a]** の **[セキュリティ]** セクションから **[ネットワーク]** を選択します。
  
3. **[ネットワーク]** ページで、**[パブリック アクセス]** タブに移動します。
  
4. **パブリック ネットワーク アクセス**が無効になっているか確認します。 無効になっている場合は、[パブリック ネットワーク アクセス] に **[選択したネットワーク]** を選択します。

>**注**: 以下の [ファイアウォール規則] セクションで構成されている IP アドレスからの接続は、このデータベースにアクセスできます。 既定では、パブリック IP アドレスは許可されていません。

5. 必要に応じて、**[ネットワーク]** ページの **[ファイアウォール規則]** セクションに移動し、クライアント IP アドレスが **"規則名"**、**"開始 IPv4 アドレス"**、および **"終了 IPv4 アドレス"** フィールドにまだ設定されていない場合は、**[+ クライアント IPv4 アドレスの追加]** を選択します。
    
     ![image](https://github.com/user-attachments/assets/dfdeffca-d33f-44e1-81db-9f68a51f89df)

6. 必要に応じて、**[保存]** を選択します。

### プライベート エンドポイントへの接続のテスト

>**注**: このタスクでは、前の手順で作成した仮想マシンを使用して、プライベート エンドポイントを通じて SQL サーバーに接続します。

1. Azure portal の検索ボックスに「**vm-3**」と入力し、それを [リソース] ドロップダウン リストから選択します。

2. vm-3 の **[概要]** ページで、**[接続]** を選択し、**[Bastion]** 選択します。

3. 仮想マシンの作成時に入力したユーザー名「**Tenantadmin2**」とパスワード「**Superuser#170**」を入力します。

   **重要:** [接続] を選択する前に、[Edge の設定]、[ポップアップとリダイレクト] に移動し、[ブロック] スイッチを **[オフ]** に切り替えます。

4. **[接続]** ボタンを選択します。
  
5. 接続後にサーバーで Windows PowerShell を開きます。

6. **sqlserver-name** を、前の手順で作成した SQL サーバーの名前に置き換えます。 たとえば、「**nslookup az-sql-srv1a.database.windows.net**」と入力すると、次のようなメッセージが表示されます。

   ````
   
   Server:  UnKnown
   Address:  168.63.129.16
   
   Non-authoritative answer:
   Name:    az-sql-srv1a.privatelink.database.windows.net
   Address:  10.1.0.5
   Aliases:  az-sql-srv1a.database.windows.net
   ````
   
>**注**: SQL サーバー名には 10.1.0.5 というプライベート IP アドレスが返されます。 このアドレスは、前に作成した **vnet-2** 仮想ネットワークの **az-sql-srv1a** サブネットにあります。

7. [SQL Server Management Studio (SSMS)](https://learn.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?preserve-view=true&amp;view=sql-server-2017) を **vm-3** にインストールします。
 
8. **SQL Server Management Studio** を開きます。

9. **[サーバーに接続]** で、次の情報を入力または選択します。

    |設定|値|
    |---|---|
    |サーバーの種類|**データベース エンジン**を選択します。|
    |サーバー名|「**az-sql-srv1a.database.windows.net**」と入力します。|
    |認証|**[SQL Server 認証]** を選択します。|
    |ユーザー名|「**Tenantadmin2**」と入力します。|
    |Password|「**Superuser#170**」と入力します。|
    |パスワードを保存する|**[はい]** を選択します。|
    |接続セキュリティ|
    |暗号化|既定の設定は [必須] のままにします。|
   
10. **[接続]** を選択します。

11. 左側のメニューでデータベースを参照します。

12. vm-3 へのリモート デスクトップ接続を閉じます。
  
> **結果**: Azure portal から Azure プライベート エンドポイントを使用して Azure SQL サーバーに接続しました。
